# Denial of Service & Distributed Denial Of Service

<br />

<p align="center">
<img src="https://cdn-icons-png.flaticon.com/512/4046/4046203.png" height="25%" width="25%" alt="Detection Engineering Logo Team Ghost"/>
</p>


<h2>Description</h2>

In this section of the project we are going to similutate both a Denial of Service and a Distributed Denial of Service attack by flooding our Windows VM with network traffic. A Denial of Service (DOS) attack is a type of cyber attack aimed at making a computer, network, or service unavailable to its intended users. This is typically accomplished by overwhelming the target system with a flood of illegitimate requests, thereby exhausting its resources (such as bandwidth, CPU, or memory) and preventing legitimate requests from being processed. A Distributed Denial of Service (DDOS) attack is an enhanced version of a DOS attack. In a DDOS attack, multiple compromised systems (often part of a botnet) are used to launch the attack simultaneously against a single target.

***Note: This attack is resource intensive I would recommend keeping an eye on your resources to make sure that you do not strain your host machine***

<br />

<h2>DOS Attack</h2>

<h3>DOS Attack Setup:</h3>

The first thing we need to do to set up this attack is to create a simple http server with python. To do this enter in this command in a powershell terminal on your Windows VM:

```powershell

python -m http.server 8000

```

<p align="center">
<img src="https://i.imgur.com/Zpjzpdj.png" height="100%" width="100%" alt="Detection Engineering Logo Team Ghost"/>
</p>


Once that is done we are ready to launch our attack.

<h3>DOS Attack Execution:</h3>

To launch the DOS attack fire up the Kali Linux VM and open up a terminal. Enter in this command:

```Bash
sudo hping3 -i u20 -S -p 8000 -c 50000 192.168.1.4
```
What this command will do is send 50,000 SYN packets to our https server on our Windows VM. 

<p align="center">
<img src="https://i.imgur.com/WgztYmu.png" height="100%" width="100%" alt="Detection Engineering Logo Team Ghost"/>
</p>


Now that we have launched our attack we are going to move forwards and create the detection for this attack.

</br>

<h2>DOS Attack Detection</h2>

<h3>DOS Query:</h3>

To create our query for this DOS attack we need to look in our Elastic environment for 50,000 events that occured in a short amount of time. This is the query we will use that illustrates just that : data_stream.dataset : "zeek.connection" and zeek.connection.state : "RSTO" and zeek.connection.state_message : "Connection established, originator aborted (sent a RST)."

<p align="center">
<img src="https://i.imgur.com/Ka2QWtk.png" height="100%" width="100%" alt="Detection Engineering Logo Team Ghost"/>
</p>

-  data_stream.dataset : "zeek.connection" looks for logs thave have the zeek.connection dataset
-  zeek.connection.state : "RSTO" looks for logs that have RTSO as its zeek connection state
-  zeek.connection.state_message : "Connection established, originator aborted (sent a RST)." looks for logs that has this message as its zeek connections state message

Now that we have our query we are ready to create 

</br>

<h3>DOS Detection Rule:</h3>

<b>Define Rule:</b>

Now that we have our query we are now going to create our detection rule. To do this copy the query and click on the hamburger icon on the top-left corner of the page. Scroll down to "Security" and select the "Rules" option. Afterwards click on "Detection Rules (SIEM)" and then select "Create New Rule". Make sure that the "Threshold" option is selected then scroll down and paste our query. Next under "Group by" enter in "source.ip" and "zeek.connection.state" and set the Threshold to >=30000. Then in the "Count" field set it to @timestamp and set the "Unique values" to >=10000. Afterwards scroll down to the "Suppress alerts by" option and select "Per time period" and select 5 minutes. What this will do is reduce the noise generated by repetitive alerts by grouping similar alerts together.

<p align="center">
<img src="https://i.imgur.com/GPpeSNc.png" height="100%" width="100%" alt="Detection Engineering Logo Team Ghost"/>
<img src="https://i.imgur.com/ZMFRvNH.png" height="100%" width="100%" alt="Detection Engineering Logo Team Ghost"/>
</p>

<b>About Rule:</b>

Next we are going to fill out the About Rule section. We are going to name the alert "DOS Attack Detected" and enter in a description for the rule. Set the "Default severity" to "High" then click on "Advance Settings". Scroll down to until you see "MITRE ATT&CK threats" and select the option for "Impact" for the technique and then add a subtechnique and set it to "Network Denial of Service". Finally add another subtechnique and set it to "Direct Network Flood".

<p align="center">
<img src="https://i.imgur.com/gdcNCNG.png" height="100%" width="100%" alt="Detection Engineering Logo Team Ghost"/>
<img src="https://i.imgur.com/UztyUit.png" height="100%" width="100%" alt="Detection Engineering Logo Team Ghost"/>
</p>

<b>Schedule Rule:</b>

Afterward, we will set the duration for how long the rule should run. We will set the rule to run every 5 minutes with a look-back time of 5 minutes. You can adjust this however you'd like.

<p align="center">
<img src="https://i.imgur.com/pdRFGaf.png" height="100%" width="100%" alt="Detection Engineering Logo Team Ghost"/>
</p>

<b>Rule Actions:</b>

Finally, we can set what action Elastic should take when this rule triggers. We can set it to send an email, send a message with slack, use microsoft teams etc. For this project we dont have to set it to anything simply click on the "Create & Enable rule" button.

<p align="center">
<img src="https://i.imgur.com/8Hm9GXc.png" height="100%" width="100%" alt="Detection Engineering Logo Team Ghost"/>
</p>

<b>Results:</b>

Now that we have set our rule we can then run hping3 command and this should trigger the alert. We can view the alert by going to "Security" and selecting the "Alerts" option.

</br>

<h2>DDOS Attack</h2>

<h3>DDOS Attack Setup:</h3>

The first thing we need to do to set up this attack is to create a simple http server with python. To do this enter in this command in a powershell terminal on your Windows VM:

```powershell

python -m http.server 8000

```

Once that is done we are ready to launch our attack.


<h3>DDOS Attack Execution:</h3>

To execute the attack we need to fire up both our Parrot OS VM and Kali Linux VM. Open up a terminal in both VMs and execute this command:

```Bash

sudo hping3 -i u20 -S -p 8000 192.168.1.4

```
This command will send a Syn Flood attack indefinetly until it is stopped with "Ctrl+C". Let it run for a few seconds and stop the attack.

<p align="center">
<img src="https://i.imgur.com/tsrPH7A.png" height="100%" width="100%" alt="Detection Engineering Logo Team Ghost"/>
</p>

We are now ready to create our detection for the DDOS attack.

</br>

<h2>DDOS Detection</h2>


<h3>DDOS Query</h3>

In the past to create our queries we used the query language "Kibana Query Language" however in this instance where we are going to need detect DOS attacks from more this one source we won't be able to use KQL to create our query. Fortunately, Elastic has another query language we can use called ES|QL or "ElasticSearch Query Language". The difference between the two is that Kibana Query Language (KQL) is a user-friendly, human-readable syntax designed for quick, ad-hoc searching and filtering within Kibana. It is easy to learn and use, making it ideal for basic queries in Kibana's Discover, Dashboard, and Visualizations sections. On the other hand, Elasticsearch Query Language (ES|QL) offers a more advanced, SQL-like syntax suited for complex querying and data analysis directly within Elasticsearch.

The query that we are going to use to detect a DDOS attack is :

```SQL

FROM logs-*
| WHERE network.transport == "tcp" and zeek.connection.state == "RSTO"
| STATS total_events = COUNT(*), unique_sources = COUNT_DISTINCT(source.ip) BY destination.ip
| WHERE total_events >= 40000 AND unique_sources >= 2

```

This query looks through logs that match the pattern logs-* and filters them to include only TCP connections that were reset by the originator (RSTO state). It then groups these logs by destination IP and calculates the total number of events and the number of unique source IP addresses for each destination IP. Finally, it filters these results to include only those destination IPs that have at least 40,000 events and at least 2 unique source IP addresses. 

<p align="center">
<img src="https://i.imgur.com/fgSF9pw.png" height="100%" width="100%" alt="Detection Engineering Logo Team Ghost"/>
</p>

Now that we have our ESQL query we are now ready to create our detection rule.

</br>

<h2>DDOS Detection</h2>

<b>Define Rule:</b>

Now that we have our query we are now going to create our detection rule. To do this copy the query and click on the hamburger icon on the top-left corner of the page. Scroll down to "Security" and select the "Rules" option. Afterwards click on "Detection Rules (SIEM)" and then select "Create New Rule". Make sure that the "ES|QL" option is selected then scroll down and paste our query.

<p align="center">
<img src="https://i.imgur.com/DTIQG7k.png" height="100%" width="100%" alt="Detection Engineering Logo Team Ghost"/>
</p>

<b>About Rule:</b>

Next we are going to fill out the About Rule section. We are going to name the alert "A DDOS Attack Detected" and enter in a description for the rule. Set the "Default severity" to "Critical" then click on "Advance Settings". Scroll down to until you see "MITRE ATT&CK threats" and select the option for "Impact" for the technique and then add a subtechnique and set it to "Network Denial of Service". Finally add another subtechnique and set it to "Direct Network Flood".

<p align="center">
<img src="https://i.imgur.com/TUoFIco.png" height="100%" width="100%" alt="Detection Engineering Logo Team Ghost"/>
<img src="https://i.imgur.com/UztyUit.png" height="100%" width="100%" alt="Detection Engineering Logo Team Ghost"/>
</p>

<b>Schedule Rule:</b>

Afterward, we will set the duration for how long the rule should run. We will set the rule to run every 5 minutes with a look-back time of 5 minutes. You can adjust this however you'd like.

<p align="center">
<img src="https://i.imgur.com/pdRFGaf.png" height="100%" width="100%" alt="Detection Engineering Logo Team Ghost"/>
</p>

<b>Rule Actions:</b>

Finally, we can set what action Elastic should take when this rule triggers. We can set it to send an email, send a message with slack, use microsoft teams etc. For this project we dont have to set it to anything simply click on the "Create & Enable rule" button.

<p align="center">
<img src="https://i.imgur.com/8Hm9GXc.png" height="100%" width="100%" alt="Detection Engineering Logo Team Ghost"/>
</p>

<b>Results:</b>

Now that we have set our rule we can then run another DDOS attack and this should trigger the alert. We can view the alert by going to "Security" and selecting the "Alerts" option. Let the attack run for about 30 seconds and wait for the alerts to pop up. This is what it should look like when the alerts come through.

<p align="center">
<img src="https://i.imgur.com/15a1VNB.png" height="100%" width="100%" alt="Detection Engineering Logo Team Ghost"/>
</p>

</br>

<h3>DOS & DDOS Attack Completed!</h3>
